#!/bin/env bash

help() {
    >&2 echo '
    usage: command

    OPTIONS:
    '
    exit
}

filter() {
    if [[ $# -eq 0 ]]; then
        echo "cat"
    else
        echo "fzf --filter \"${*}\" --exact --scheme history --tiebreak \"end,chunk,index\""
    fi
}

zoxide_directores() {
    action=/tmp/$$
    [[ -e $action ]] && exit 1
    trap "command rm -f $action" EXIT SIGINT SIGTERM

    action_ff="execute($CUSTOM_HOME/scripts/fzf/find-files ${fzf_bin:---no-popup} {+})"
    action_ft="transform:echo f > $action; echo accept"
    action_sf="execute($CUSTOM_HOME/scripts/fzf/search-string ${fzf_bin:---no-popup} {+})"
    action_st="transform:echo g > $action; echo accept"
    action_e="execute(${EDITOR} {+} > /dev/tty < /dev/tty)"

    # shellcheck disable=SC2068
    readarray -t directories < <(
        zoxide query --list | eval "$(filter $@)" | lscolors |
            ${fzf_bin:-fzf} \
                --prompt "Zoxide> " \
                --exact --scheme path \
                --delimiter / --nth -1,-2,-3 \
                --exit-0 --header-first \
                --header "keybindings: C-f(find files), C-g(grep string), C-s(hsp), C-v(vsp), C-o(fzf-tmux-menu), A-e(execute editor), Enter(select or new file)" \
                --bind="ctrl-f:transform:[ \"${fzf_bin}\" ] && echo \"$action_ft\" || echo \"$action_ff\"" \
                --bind="ctrl-g:transform:[ \"${fzf_bin}\" ] && echo \"$action_st\" || echo \"$action_sf\"" \
                --bind="ctrl-s:transform:echo h > $action; echo accept" \
                --bind="ctrl-v:transform:echo v > $action; echo accept" \
                --bind="ctrl-o:transform:echo  m > $action; echo accept" \
                --bind="alt-e:transform:[[ \"${fzf_bin}\" ]] && echo \"ignore\" || echo \"${action_e}\"" \
                --bind="enter:accept-or-print-query"
    )
}

exec_action() {
    flag=$(command cat "$action" 2> /dev/null)

    if [[ "f" == "$flag" ]]; then
        $CUSTOM_HOME/scripts/fzf/find-files "${directories[@]}"
    elif [[ "g" == "$flag" ]]; then
        $CUSTOM_HOME/scripts/fzf/search-string "${directories[@]}"
    else
        mkdir -p "$(dirname "${directories}")" &> /dev/null
        if [[ "${flag}" =~ ^(h|v)$ ]]; then
            tmux splitw "-b${flag}" zsh -c "${EDITOR} ${directories}"
        elif [[ "${flag}" == m ]]; then
            $CUSTOM_HOME/scripts/tmux/tmux-menu $(realpath "${directories}")
        else
            ${EDITOR} "${directories}"

        fi
    fi
}

main() {
    [[ -v TMUX ]] && command -v fzf-tmux &> /dev/null && fzf_bin="fzf-tmux $FZF_TMUX_OPTS"

    typeset directories action

    typeset args

    args=$(getopt -o z -l no-popup -n "$0" -- "$@")
    eval set -- "$args"

    while true; do
        case $1 in
        --no-popup)
            fzf_bin=
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "arg error"
            exit 1
            ;;
        esac
    done

    zoxide_directores "$@"

    [[ ${#directories[@]} -gt 0 ]] && exec_action
}

main "$@"
